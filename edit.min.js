"use strict";angular.module("sc.edit",[]).directive("scEdit",["$rootScope",function($rootScope){function ScEdit(type,element,ngModel,placeholder,onbeforesave,onaftersave){this.type=type,this.element=element,this.ngModel=ngModel,this.placeholder=placeholder,this.onbeforesave=onbeforesave?onbeforesave:angular.noop,this.onaftersave=onaftersave?onaftersave:angular.noop,this.$data=ngModel.$viewValue,this.setupEvents()}var events={editionStart:"focus",editionEnd:"blur"};return ScEdit.prototype.init=function(){this.element.html(this.ngModel.$isEmpty(this.ngModel.$viewValue)?this.placeholder:this.ngModel.$viewValue)},ScEdit.prototype.editionStart=function(){this.element.html(this.ngModel.$viewValue||"")},ScEdit.prototype.getError=function(){var value=this.element.html();return""!==value&&this.onbeforesave({$data:value})},ScEdit.prototype.editionEnd=function(){var content=this.element.html(),errorMessage=this.getError();return errorMessage?(this.element.popover({container:"body",content:errorMessage,trigger:"manual"}),this.element.popover("show")):(this.element.popover("hide"),this.commitValue(content),this.onaftersave({$data:content}),this.init()),this.ngModel.$setValidity("scedit",!errorMessage),!errorMessage},ScEdit.prototype.commitValue=function(value){var self=this;$rootScope.$apply(function(){self.ngModel.$setViewValue(value)})},ScEdit.prototype.onKeydown=function(e){27===e.keyCode?(this.element.html(this.ngModel.$viewValue||""),this.element.blur()):13===e.keyCode?"textarea"!==this.type&&(e.stopPropagation(),e.preventDefault()):9===e.keyCode&&this.getError()&&(e.stopPropagation(),e.preventDefault())},ScEdit.prototype.setupEvents=function(){var self=this;this.element.on("keydown",function(e){return self.onKeydown(e)}),this.element.on(events.editionStart,function(e){return self.editionStart(e)}),this.element.on(events.editionEnd,function(e){return self.editionEnd(e)})},{restrict:"A",scope:{placeholder:"=",onbeforesave:"&",onaftersave:"&",type:"@scEdit"},require:"ngModel",link:function(scope,element,attrs,ngModel){function init(){return scope.$data=ngModel.$viewValue,editor.init()}var editor=new ScEdit(scope.type||"text",element,ngModel,scope.placeholder,attrs.onbeforesave?scope.onbeforesave:void 0,attrs.onaftersave?scope.onaftersave:void 0);scope.$watch(function(){return ngModel.$viewValue},init)}}}]);